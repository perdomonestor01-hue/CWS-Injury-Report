<!-- Analytics Header with Date Range Filter -->
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Analytics & Insights</h1>
        <p class="text-gray-600">Comprehensive portfolio performance analysis and business intelligence</p>
    </div>
    <div class="mt-4 lg:mt-0 flex items-center space-x-4">
        <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">Time Period:</label>
            <select id="timePeriodFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <option value="12m">Last 12 Months</option>
                <option value="6m">Last 6 Months</option>
                <option value="3m">Last 3 Months</option>
                <option value="1m">Last Month</option>
                <option value="ytd">Year to Date</option>
                <option value="all">All Time</option>
            </select>
        </div>
        <button onclick="exportReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
            <i class="fas fa-download mr-2"></i>Export Report
        </button>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-8">
    <div class="metric-card metric-neutral card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-xs uppercase tracking-wide">Portfolio Value</p>
                <p class="text-2xl font-bold text-gray-800">{{formatCurrency kpis.portfolioValue}}</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
                <i class="fas fa-building text-purple-600 text-lg"></i>
            </div>
        </div>
    </div>

    <div class="metric-card metric-positive card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-xs uppercase tracking-wide">Occupancy Rate</p>
                <p class="text-2xl font-bold text-green-600">{{formatPercent kpis.occupancyRate}}</p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
                <i class="fas fa-chart-pie text-green-600 text-lg"></i>
            </div>
        </div>
    </div>

    <div class="metric-card metric-warning card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-xs uppercase tracking-wide">Avg Rent/Property</p>
                <p class="text-2xl font-bold text-orange-600">{{formatCurrency kpis.averageRentPerProperty}}</p>
            </div>
            <div class="bg-orange-100 p-3 rounded-full">
                <i class="fas fa-home text-orange-600 text-lg"></i>
            </div>
        </div>
    </div>

    <div class="metric-card {{#if (lt kpis.averageExpenseRatio 30)}}metric-positive{{else if (gt kpis.averageExpenseRatio 50)}}metric-negative{{else}}metric-warning{{/if}} card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-xs uppercase tracking-wide">Expense Ratio</p>
                <p class="text-2xl font-bold {{#if (lt kpis.averageExpenseRatio 30)}}text-green-600{{else if (gt kpis.averageExpenseRatio 50)}}text-red-600{{else}}text-orange-600{{/if}}">
                    {{formatPercent kpis.averageExpenseRatio}}
                </p>
            </div>
            <div class="{{#if (lt kpis.averageExpenseRatio 30)}}bg-green-100{{else if (gt kpis.averageExpenseRatio 50)}}bg-red-100{{else}}bg-orange-100{{/if}} p-3 rounded-full">
                <i class="fas fa-credit-card {{#if (lt kpis.averageExpenseRatio 30)}}text-green-600{{else if (gt kpis.averageExpenseRatio 50)}}text-red-600{{else}}text-orange-600{{/if}} text-lg"></i>
            </div>
        </div>
    </div>

    <div class="metric-card metric-positive card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-xs uppercase tracking-wide">Cash-on-Cash Return</p>
                <p class="text-2xl font-bold text-blue-600">{{formatPercent kpis.cashOnCashReturn}}</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
                <i class="fas fa-percentage text-blue-600 text-lg"></i>
            </div>
        </div>
    </div>

    <div class="metric-card metric-neutral card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-xs uppercase tracking-wide">Total Equity</p>
                <p class="text-2xl font-bold text-indigo-600">{{formatCurrency kpis.totalEquity}}</p>
            </div>
            <div class="bg-indigo-100 p-3 rounded-full">
                <i class="fas fa-coins text-indigo-600 text-lg"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Cash Flow Trends Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-chart-line text-blue-500 mr-2"></i>
                Cash Flow Trends
            </h3>
            <div class="flex items-center space-x-2">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-xs text-gray-600">Income</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                    <span class="text-xs text-gray-600">Expenses</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                    <span class="text-xs text-gray-600">Net Income</span>
                </div>
            </div>
        </div>
        <div class="h-80">
            <canvas id="cashFlowChart"></canvas>
        </div>
    </div>

    <!-- ROI Distribution Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-chart-bar text-purple-500 mr-2"></i>
                ROI Distribution
            </h3>
            <span class="text-sm text-gray-500">{{portfolioMetrics.totalProperties}} properties</span>
        </div>
        <div class="h-80">
            <canvas id="roiDistributionChart"></canvas>
        </div>
    </div>
</div>

<!-- Performance Analysis -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Manager Performance Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-users text-green-500 mr-2"></i>
                Manager Performance
            </h3>
            <a href="/managers" class="text-blue-600 hover:text-blue-800 text-sm">View Details</a>
        </div>
        <div class="h-80">
            <canvas id="managerPerformanceChart"></canvas>
        </div>
    </div>

    <!-- Expense Categories Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-chart-pie text-orange-500 mr-2"></i>
                Expense Breakdown
            </h3>
            <span class="text-sm text-gray-500">{{formatCurrency portfolioMetrics.totalExpenses}} total</span>
        </div>
        <div class="h-80">
            <canvas id="expenseCategoriesChart"></canvas>
        </div>
    </div>
</div>

<!-- Geographic Performance -->
<div class="bg-white rounded-lg shadow-sm p-6 mb-8">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-800">
            <i class="fas fa-map-marked-alt text-indigo-500 mr-2"></i>
            Geographic Performance Analysis
        </h3>
        <button onclick="toggleView('geographic')" class="text-blue-600 hover:text-blue-800 text-sm">
            <i class="fas fa-exchange-alt mr-1"></i>Switch View
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- City Performance Chart -->
        <div class="lg:col-span-2">
            <div class="h-80">
                <canvas id="cityPerformanceChart"></canvas>
            </div>
        </div>

        <!-- City Performance Table -->
        <div class="lg:col-span-1">
            <div class="max-h-80 overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="text-left p-3 font-medium text-gray-700">City</th>
                            <th class="text-right p-3 font-medium text-gray-700">Avg ROI</th>
                            <th class="text-right p-3 font-medium text-gray-700">Properties</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each cityPerformance}}
                        <tr class="border-b border-gray-100">
                            <td class="p-3 font-medium">{{@key}}</td>
                            <td class="p-3 text-right {{#if (gt this.avgROI 0)}}text-green-600{{else}}text-red-600{{/if}}">
                                {{formatPercent this.avgROI}}
                            </td>
                            <td class="p-3 text-right text-gray-600">{{this.count}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Property Performance Tables -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Top Performers -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                Top Performing Properties
            </h3>
            <span class="text-sm text-gray-500">Top 10 by ROI</span>
        </div>

        <div class="space-y-3">
            {{#each topPerformers}}
            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border-l-4 border-green-400 hover:bg-green-100 transition">
                <div class="flex-1">
                    <p class="font-medium text-gray-800 truncate">{{address}}</p>
                    <div class="flex items-center space-x-4 text-sm text-gray-600 mt-1">
                        <span><i class="fas fa-user mr-1"></i>{{manager}}</span>
                        <span><i class="fas fa-dollar-sign mr-1"></i>{{formatCurrency rent_income}}/mo</span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold text-green-600">{{formatPercent roi}}</p>
                    <p class="text-xs text-gray-500">ROI</p>
                </div>
            </div>
            {{/each}}
        </div>
    </div>

    <!-- Bottom Performers -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                Properties Needing Attention
            </h3>
            <span class="text-sm text-gray-500">Lowest ROI</span>
        </div>

        <div class="space-y-3">
            {{#each bottomPerformers}}
            <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg border-l-4 border-red-400 hover:bg-red-100 transition">
                <div class="flex-1">
                    <p class="font-medium text-gray-800 truncate">{{address}}</p>
                    <div class="flex items-center space-x-4 text-sm text-gray-600 mt-1">
                        <span><i class="fas fa-user mr-1"></i>{{manager}}</span>
                        <span><i class="fas fa-dollar-sign mr-1"></i>{{formatCurrency rent_income}}/mo</span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold {{#if (gt roi 0)}}text-orange-600{{else}}text-red-600{{/if}}">
                        {{formatPercent roi}}
                    </p>
                    <p class="text-xs text-gray-500">ROI</p>
                </div>
            </div>
            {{/each}}
        </div>
    </div>
</div>

<!-- Manager Performance Detailed Table -->
<div class="bg-white rounded-lg shadow-sm p-6 mb-8">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-800">
            <i class="fas fa-chart-line text-blue-500 mr-2"></i>
            Manager Performance Analysis
        </h3>
        <div class="flex items-center space-x-2">
            <button onclick="sortTable('managerTable', 'roi')" class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-sort mr-1"></i>Sort by ROI
            </button>
            <button onclick="sortTable('managerTable', 'efficiency')" class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-sort mr-1"></i>Sort by Efficiency
            </button>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table id="managerTable" class="w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="text-left p-4 font-medium text-gray-700">Manager</th>
                    <th class="text-right p-4 font-medium text-gray-700">Properties</th>
                    <th class="text-right p-4 font-medium text-gray-700">Total Rent Income</th>
                    <th class="text-right p-4 font-medium text-gray-700">Total Expenses</th>
                    <th class="text-right p-4 font-medium text-gray-700">Net Income</th>
                    <th class="text-right p-4 font-medium text-gray-700">Average ROI</th>
                    <th class="text-right p-4 font-medium text-gray-700">Efficiency</th>
                    <th class="text-center p-4 font-medium text-gray-700">Performance</th>
                </tr>
            </thead>
            <tbody>
                {{#each managerPerformance}}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="p-4 font-medium">{{name}}</td>
                    <td class="p-4 text-right">{{propertyCount}}</td>
                    <td class="p-4 text-right text-green-600">{{formatCurrency totalRentIncome}}</td>
                    <td class="p-4 text-right text-red-600">{{formatCurrency totalExpenses}}</td>
                    <td class="p-4 text-right {{#if (gt netIncome 0)}}text-green-600{{else}}text-red-600{{/if}}">
                        {{formatCurrency netIncome}}
                    </td>
                    <td class="p-4 text-right {{#if (gt averageROI 10)}}text-green-600{{else if (gt averageROI 5)}}text-orange-600{{else}}text-red-600{{/if}}">
                        {{formatPercent averageROI}}
                    </td>
                    <td class="p-4 text-right {{#if (gt efficiency 70)}}text-green-600{{else if (gt efficiency 50)}}text-orange-600{{else}}text-red-600{{/if}}">
                        {{formatPercent efficiency}}
                    </td>
                    <td class="p-4 text-center">
                        {{#if (gt averageROI 12)}}
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Excellent</span>
                        {{else if (gt averageROI 8)}}
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Good</span>
                        {{else if (gt averageROI 5)}}
                            <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Average</span>
                        {{else}}
                            <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Needs Review</span>
                        {{/if}}
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
</div>

<!-- Property Type Analysis -->
<div class="bg-white rounded-lg shadow-sm p-6 mb-8">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-800">
            <i class="fas fa-building text-purple-500 mr-2"></i>
            Property Type Performance
        </h3>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {{#each propertyTypes}}
        <div class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition">
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-gray-800">{{@key}}</h4>
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{{this.count}} units</span>
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Total Rent:</span>
                    <span class="text-green-600">{{formatCurrency this.totalRent}}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Expenses:</span>
                    <span class="text-red-600">{{formatCurrency this.totalExpenses}}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Avg ROI:</span>
                    <span class="{{#if (gt (divide this.totalROI this.count) 10)}}text-green-600{{else if (gt (divide this.totalROI this.count) 5)}}text-orange-600{{else}}text-red-600{{/if}}">
                        {{formatPercent (divide this.totalROI this.count)}}
                    </span>
                </div>
            </div>
        </div>
        {{/each}}
    </div>
</div>

<!-- Insights and Recommendations -->
<div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg p-6 text-white">
    <div class="flex items-center mb-6">
        <i class="fas fa-lightbulb text-2xl mr-3"></i>
        <h3 class="text-xl font-bold">AI-Powered Insights & Recommendations</h3>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Optimization Opportunities -->
        <div class="bg-white bg-opacity-10 rounded-lg p-4">
            <h4 class="font-medium mb-3">
                <i class="fas fa-chart-line mr-2"></i>
                Optimization Opportunities
            </h4>
            <ul class="space-y-2 text-sm">
                <li class="flex items-start">
                    <i class="fas fa-arrow-up text-green-300 mt-1 mr-2"></i>
                    <span>Properties with ROI below 5% need immediate attention</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-dollar-sign text-yellow-300 mt-1 mr-2"></i>
                    <span>Consider rent increases for properties at market rates</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-tools text-blue-300 mt-1 mr-2"></i>
                    <span>High maintenance costs indicate needed upgrades</span>
                </li>
            </ul>
        </div>

        <!-- Market Trends -->
        <div class="bg-white bg-opacity-10 rounded-lg p-4">
            <h4 class="font-medium mb-3">
                <i class="fas fa-trending-up mr-2"></i>
                Market Trends
            </h4>
            <ul class="space-y-2 text-sm">
                <li class="flex items-start">
                    <i class="fas fa-home text-green-300 mt-1 mr-2"></i>
                    <span>Single-family homes showing strongest performance</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-map-marker-alt text-purple-300 mt-1 mr-2"></i>
                    <span>Geographic diversification recommendations available</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-calendar text-orange-300 mt-1 mr-2"></i>
                    <span>Seasonal patterns identified in cash flow</span>
                </li>
            </ul>
        </div>

        <!-- Action Items -->
        <div class="bg-white bg-opacity-10 rounded-lg p-4">
            <h4 class="font-medium mb-3">
                <i class="fas fa-tasks mr-2"></i>
                Recommended Actions
            </h4>
            <ul class="space-y-2 text-sm">
                <li class="flex items-start">
                    <i class="fas fa-check text-green-300 mt-1 mr-2"></i>
                    <span>Schedule property inspections for underperformers</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-user-tie text-blue-300 mt-1 mr-2"></i>
                    <span>Review manager performance metrics</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-calculator text-yellow-300 mt-1 mr-2"></i>
                    <span>Conduct market analysis for rent optimization</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- Chart Initialization Script -->
<script>
// Chart data from server
const chartData = {
    roiDistribution: {{{chartData.roiDistribution}}},
    managerPerformance: {{{chartData.managerPerformance}}},
    propertyTypes: {{{chartData.propertyTypes}}},
    cityPerformance: {{{chartData.cityPerformance}}},
    cashFlowTrends: {{{chartData.cashFlowTrends}}},
    expenseCategories: {{{chartData.expenseCategories}}}
};

// Chart configuration
Chart.defaults.font.family = "'Inter', system-ui, sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = '#6B7280';

// Initialize all charts when document is ready
document.addEventListener('DOMContentLoaded', function() {
    initializeCashFlowChart();
    initializeROIDistributionChart();
    initializeManagerPerformanceChart();
    initializeExpenseCategoriesChart();
    initializeCityPerformanceChart();
});

// Cash Flow Trends Chart
function initializeCashFlowChart() {
    const ctx = document.getElementById('cashFlowChart').getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.cashFlowTrends.map(item => item.month),
            datasets: [
                {
                    label: 'Income',
                    data: chartData.cashFlowTrends.map(item => item.income),
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Expenses',
                    data: chartData.cashFlowTrends.map(item => item.expenses),
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Net Income',
                    data: chartData.cashFlowTrends.map(item => item.netIncome),
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#F3F4F6'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// ROI Distribution Chart
function initializeROIDistributionChart() {
    const ctx = document.getElementById('roiDistributionChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(chartData.roiDistribution),
            datasets: [{
                label: 'Number of Properties',
                data: Object.values(chartData.roiDistribution),
                backgroundColor: [
                    '#EF4444',
                    '#F59E0B',
                    '#10B981',
                    '#3B82F6',
                    '#8B5CF6'
                ],
                borderColor: [
                    '#DC2626',
                    '#D97706',
                    '#059669',
                    '#2563EB',
                    '#7C3AED'
                ],
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    callbacks: {
                        label: function(context) {
                            const total = Object.values(chartData.roiDistribution).reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                            return `${context.parsed.y} properties (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#F3F4F6'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Manager Performance Chart
function initializeManagerPerformanceChart() {
    const ctx = document.getElementById('managerPerformanceChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.managerPerformance.map(manager => manager.name),
            datasets: [{
                label: 'Average ROI (%)',
                data: chartData.managerPerformance.map(manager => manager.averageROI),
                backgroundColor: chartData.managerPerformance.map(manager =>
                    manager.averageROI > 10 ? '#10B981' :
                    manager.averageROI > 5 ? '#F59E0B' : '#EF4444'
                ),
                borderColor: chartData.managerPerformance.map(manager =>
                    manager.averageROI > 10 ? '#059669' :
                    manager.averageROI > 5 ? '#D97706' : '#DC2626'
                ),
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    callbacks: {
                        afterLabel: function(context) {
                            const manager = chartData.managerPerformance[context.dataIndex];
                            return [
                                `Properties: ${manager.propertyCount}`,
                                `Net Income: $${manager.netIncome.toLocaleString()}`,
                                `Efficiency: ${manager.efficiency.toFixed(1)}%`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: '#F3F4F6'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Expense Categories Chart
function initializeExpenseCategoriesChart() {
    const ctx = document.getElementById('expenseCategoriesChart').getContext('2d');

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(chartData.expenseCategories),
            datasets: [{
                data: Object.values(chartData.expenseCategories),
                backgroundColor: [
                    '#EF4444',
                    '#F59E0B',
                    '#10B981',
                    '#3B82F6',
                    '#8B5CF6',
                    '#EC4899',
                    '#6B7280'
                ],
                borderColor: '#ffffff',
                borderWidth: 3,
                hoverBorderWidth: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            return data.labels.map((label, index) => {
                                const value = data.datasets[0].data[index];
                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return {
                                    text: `${label}: $${value.toLocaleString()} (${percentage}%)`,
                                    fillStyle: data.datasets[0].backgroundColor[index],
                                    pointStyle: 'circle'
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: $${context.parsed.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// City Performance Chart
function initializeCityPerformanceChart() {
    const ctx = document.getElementById('cityPerformanceChart').getContext('2d');
    const cities = Object.keys(chartData.cityPerformance);
    const avgROIs = cities.map(city => chartData.cityPerformance[city].avgROI);

    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: cities,
            datasets: [{
                label: 'Average ROI (%)',
                data: avgROIs,
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderColor: '#3B82F6',
                borderWidth: 3,
                pointBackgroundColor: '#3B82F6',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    callbacks: {
                        afterLabel: function(context) {
                            const cityData = chartData.cityPerformance[context.label];
                            return [
                                `Properties: ${cityData.count}`,
                                `Total Rent: $${cityData.totalRent.toLocaleString()}`,
                                `Total Expenses: $${cityData.totalExpenses.toLocaleString()}`
                            ];
                        }
                    }
                }
            },
            scales: {
                r: {
                    angleLines: {
                        color: '#E5E7EB'
                    },
                    grid: {
                        color: '#F3F4F6'
                    },
                    pointLabels: {
                        font: {
                            size: 12
                        }
                    },
                    ticks: {
                        beginAtZero: true,
                        stepSize: 5,
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// Utility Functions
function exportReport() {
    const reportData = {
        timestamp: new Date().toISOString(),
        portfolioMetrics: {{{json portfolioMetrics}}},
        kpis: {{{json kpis}}},
        managerPerformance: {{{json managerPerformance}}},
        topPerformers: {{{json topPerformers}}},
        bottomPerformers: {{{json bottomPerformers}}}
    };

    const dataStr = JSON.stringify(reportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

    const exportFileDefaultName = `ben-zen-properties-analytics-${new Date().toISOString().split('T')[0]}.json`;

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();

    showNotification('Analytics report exported successfully!', 'success');
}

function sortTable(tableId, column) {
    // This would implement table sorting functionality
    showNotification(`Sorting by ${column}...`, 'info');
}

function toggleView(section) {
    showNotification(`Switching ${section} view...`, 'info');
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg text-white ${
        type === 'success' ? 'bg-green-600' :
        type === 'info' ? 'bg-blue-600' : 'bg-red-600'
    } transform transition-transform duration-300 translate-x-full`;

    notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'info' ? 'info-circle' : 'exclamation-triangle'}"></i>
            <span>${message}</span>
        </div>
    `;

    document.body.appendChild(notification);

    // Slide in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);

    // Slide out after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Filter functionality
document.getElementById('timePeriodFilter').addEventListener('change', function() {
    const period = this.value;
    showNotification(`Filtering data for ${period}...`, 'info');
    // In a real application, this would trigger a data refresh
});
</script>